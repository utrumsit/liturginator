# Work Log - December 7, 2024

## Completed Today

### Kathisma Improvements
- Fixed kathismata.py to properly structure stasis endings and ektenias
- After each stasis: Glory.../Alleluia (3x)/Lord have mercy (3x)/Glory.../Priest exclamation/Amen
- Three different priest exclamations:
  1. "For Yours is the might, and Yours are the kingdom..."
  2. "For You are a good and loving God..."
  3. "For You are our God..."
- Little Ektenia ("Again and again, in peace...") comes only ONCE at the very end of the kathisma, not after each stasis

### Vespers Resource Files Created
- `resource/psalm103.md` - Opening psalm with poetic formatting (double spaces for line breaks)
- `resource/great_litany.md` - Cleaned up from chasoslov, with italicized rubrics
- `resource/little_ektenia.md` - For use after kathisma
- `resource/lamplighting_psalms.md` - Psalms 140, 141, 129, 116 with **On 10:** through **On 1:** markers for stichera insertion

### Menaion Scraper Updates (scrape_mci_menaion.py)
- Fixed melody extraction - now captures "special melody" from `<em>` tags (e.g., "Nebesnych ƒçinov")
- Added capture of Glory sticheron (doxasticon) - the Theotokion/Dogmatikon after "Glory"
- Added capture of "Now and ever" rubric (e.g., "Theotokion, or Stavrotheotokion")
- Fixed bug where "Glory, now and ever ‚Äì Troparion" was being incorrectly captured as a sticheron

### Menaion.py Updates
- Switched from menaion_data.json to menaion_complete.json
- Updated to handle new data structure (troparia/kontakia as dicts with main/additional)
- Added stichera output in print_feast()
- Added get_stichera() method for programmatic access

## Vespers Structure So Far

1. ‚úÖ Introductory prayers ‚Üí `resource/introductory_prayers.md`
2. ‚úÖ Psalm 103 ‚Üí `resource/psalm103.md`
3. ‚úÖ Great Litany ‚Üí `resource/great_litany.md`
4. ‚úÖ Kathisma ‚Üí `kathismata.py` (Kathisma 1 for Saturday evening)
5. ‚úÖ Lamplighting Psalms ‚Üí `resource/lamplighting_psalms.md`
6. üî≤ Stichera insertion logic (partially understood)
7. üî≤ Gladsome Light
8. üî≤ Prokeimenon
9. üî≤ Rest of vespers...

## Stichera Logic (What We Learned)

The stichera at "Lord, I Have Cried" work like this:

- **6 stichera total** (for a typical saint's day):
  - 3 from Octoechos (based on day of week + tone of the week)
  - 3 from Menaion (for the saint)

- **Insertion**: Start at the **On X:** marker matching the stichera count, work down to **On 1:**

- **Glory** - Doxasticon from the Menaion (now captured as `glory_sticheron`)

- **Now and ever** - Theotokion from the Octoechos, but the tone is determined by the **tone of the preceding doxasticon**, NOT the tone of the week

## TODO

### Immediate
- [x] Run the updated scraper to regenerate menaion_complete.json with glory_sticheron and melody data
  - Results: 351 days, 297 with stichera, 156 with glory_sticheron, 273 with melody

### Octoechos Data Needed (BOOKMARK)
**Priority: Must extract before vespers builder is complete**
- Daily vespers stichera (by day of week and tone) - 3 stichera per day/tone combo
- Theotokia collection (by tone, for "Now and ever" after Glory)
- Source: MCI website has PDFs with sheet music - text-based but would need extraction
- The Octoechos PDFs are organized by tone, contain the weekly cycle
- **Note**: The Theotokion tone follows the DOXASTICON tone, not the weekly tone

### Vespers Builder
- [ ] Create vespers.py that stitches all the pieces together
- [ ] Implement stichera insertion logic for lamplighting psalms
- [ ] Handle the Octoechos + Menaion combination when Octoechos data is available
- [x] Add O Joyful Light ‚Üí `resource/o_joyful_light.md`
- [x] Add Prokeimenon logic ‚Üí `vespers_prokeimenon.py` and `resource/prokeimena_vespers.md`
  - Weekday-dependent prokeimena for ordinary time
  - Lenten Alleluia verses for Great Lent (Mon-Thu only)
  - Minor fast logic using feast_level from menaion_complete.json
- [x] Add Paramia (readings) logic ‚Üí `vespers_paramia.py`
  - Uses scripture_readings.json for fixed feasts and paschal cycle
  - Checks if TOMORROW is a feast day (paramia read on EVE)
  - Formats output with proper liturgical rubrics (Wisdom!/A reading from.../Let us be attentive.)
